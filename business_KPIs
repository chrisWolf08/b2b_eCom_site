
SELECT
  -- 1. Parse Date
  PARSE_DATE('%Y%m%d', _TABLE_SUFFIX) AS event_date,
  COUNT(DISTINCT user_pseudo_id) AS total_users,

  -- 3. Sessions (Using your specific logic)
  -- We must CAST the int_value to STRING for CONCAT to work in BigQuery
  COUNT(DISTINCT CONCAT(
    user_pseudo_id, 
    CAST((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS STRING)
  )) AS sessions,

  COUNT(DISTINCT CASE 
    WHEN event_name = 'add_to_cart' THEN user_pseudo_id 
    ELSE NULL 
  END) AS users_with_add_to_cart, 

    COUNT(DISTINCT CASE 
    WHEN event_name = 'view_cart' THEN user_pseudo_id 
    ELSE NULL 
  END) AS users_with_view_cart

FROM
  `neogen-ga4-export.analytics_331328809.events_*`
WHERE
  _TABLE_SUFFIX BETWEEN '20251125' AND FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY))
GROUP BY
  1
ORDER BY
  1 DESC;
